<!DOCTYPE html>
<html>
<head>
  <title>Chantel Compatibility Report</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #009900; color: white; }
    tr:nth-child(even) { background-color: #f2f2f2; }
    .pass { background-color: #d4edda; font-weight: bold; }
    .close { background-color: #fff3cd; }
    .fail { background-color: #f8d7da; }
    h1 { color: #009900; }
    .stats { background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 20px 0; }
  </style>
</head>
<body>
  <h1>üîç Chantel's Compatibility Report</h1>
  <div id="loading">Loading users and calculating compatibility...</div>
  <div id="stats" class="stats" style="display:none;"></div>
  <table id="results" style="display:none;">
    <thead>
      <tr>
        <th>Rank</th>
        <th>Name</th>
        <th>Email</th>
        <th>Company</th>
        <th>Industry</th>
        <th>Score</th>
        <th>Status</th>
        <th>Goals</th>
        <th>Orgs</th>
        <th>Prof Int</th>
        <th>Industry</th>
        <th>Gender</th>
        <th>Age</th>
        <th>Personal</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    const supabase = createClient(
      'https://hrxbqhpdbnlitdvcdwpu.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhyeGJxaHBkYm5saXRkdmNkd3B1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mjk3MDE5NzAsImV4cCI6MjA0NTI3Nzk3MH0.vYy3p7KlIhBgYxaHPGKGpOXyO1Gt-9Q-JbcJ4i6X-bQ'
    );

    // Your ACTUAL algorithm (copy-pasted from matchingAlgorithm.js)
    function calculateCompatibility(user1, user2) {
      let totalScore = 0;
      const matches = {
        networkingGoals: { score: 0, details: [] },
        organizations: { score: 0, details: [] },
        professionalInterests: { score: 0, details: [] },
        industry: { score: 0, details: [] },
        gender: { score: 0, details: [] },
        age: { score: 0, details: [] },
        personalInterests: { score: 0, details: [] }
      };

      // 1. NETWORKING GOALS (25 points)
      const goals1 = user1.networkingGoals ? user1.networkingGoals.split(',').map(g => g.trim().toLowerCase()) : [];
      const goals2 = user2.networkingGoals ? user2.networkingGoals.split(',').map(g => g.trim().toLowerCase()) : [];
      const goalsOverlap = goals1.filter(g => goals2.includes(g)).length;
      matches.networkingGoals.score = Math.min(goalsOverlap * 6.25, 25);
      totalScore += matches.networkingGoals.score;

      // 2. ORGANIZATIONS (50 points)
      const orgs1Attend = user1.orgsAttend ? user1.orgsAttend.split(',').map(o => o.trim().toLowerCase()) : [];
      const orgs1CheckOut = user1.orgsWantToCheckOut ? user1.orgsWantToCheckOut.split(',').map(o => o.trim().toLowerCase()) : [];
      const orgs2Attend = user2.orgsAttend ? user2.orgsAttend.split(',').map(o => o.trim().toLowerCase()) : [];
      const orgs2CheckOut = user2.orgsWantToCheckOut ? user2.orgsWantToCheckOut.split(',').map(o => o.trim().toLowerCase()) : [];

      const complementary1 = orgs1Attend.filter(o => orgs2CheckOut.includes(o)).length;
      const complementary2 = orgs2Attend.filter(o => orgs1CheckOut.includes(o)).length;
      const sameAttend = orgs1Attend.filter(o => orgs2Attend.includes(o)).length;
      const sameCheckOut = orgs1CheckOut.filter(o => orgs2CheckOut.includes(o)).length;

      matches.organizations.score = Math.min(complementary1 * 12.5, 25) + Math.min(complementary2 * 12.5, 25);
      matches.organizations.score += Math.min(sameAttend * 12.5, 25) + Math.min(sameCheckOut * 12.5, 25);
      matches.organizations.score = Math.min(matches.organizations.score, 50);
      totalScore += matches.organizations.score;

      // 3. PROFESSIONAL INTERESTS (15 points)
      const prof1 = user1.professionalInterests ? user1.professionalInterests.split(',').map(p => p.trim().toLowerCase()) : [];
      const prof2 = user2.professionalInterests ? user2.professionalInterests.split(',').map(p => p.trim().toLowerCase()) : [];
      const profOverlap = prof1.filter(p => prof2.includes(p)).length;
      matches.professionalInterests.score = Math.min(profOverlap * 5, 15);
      totalScore += matches.professionalInterests.score;

      // 4. INDUSTRY (5 points)
      if (user1.industry && user2.industry && user1.industry.toLowerCase() === user2.industry.toLowerCase()) {
        matches.industry.score = 5;
        totalScore += 5;
      }

      // 5. GENDER PREFERENCE (5 points)
      const g1Pref = (user1.genderPreference || '').toLowerCase();
      const g2Pref = (user2.genderPreference || '').toLowerCase();
      const g1 = (user1.gender || '').toLowerCase();
      const g2 = (user2.gender || '').toLowerCase();

      if (g1Pref === 'no preference' && g2Pref === 'no preference') {
        matches.gender.score = 5;
      } else if (g1Pref === 'no preference' || g2Pref === 'no preference') {
        matches.gender.score = 2.5;
      } else if (g1Pref === g2 && g2Pref === g1) {
        matches.gender.score = 5;
      } else if (g1Pref === g2 || g2Pref === g1) {
        matches.gender.score = 2.5;
      }
      totalScore += matches.gender.score;

      // 6. AGE PREFERENCE (5 points)
      const age1Pref = (user1.agePreference || '').toLowerCase();
      const age2Pref = (user2.agePreference || '').toLowerCase();

      if (age1Pref === 'no preference' && age2Pref === 'no preference') {
        matches.age.score = 5;
      } else if (age1Pref === 'no preference' || age2Pref === 'no preference') {
        matches.age.score = 2.5;
      } else if (Math.abs(user1.age - user2.age) <= 10) {
        matches.age.score = 5;
      }
      totalScore += matches.age.score;

      // 7. PERSONAL INTERESTS (5 points)
      const pers1 = user1.personalInterests ? user1.personalInterests.split(',').map(p => p.trim().toLowerCase()) : [];
      const pers2 = user2.personalInterests ? user2.personalInterests.split(',').map(p => p.trim().toLowerCase()) : [];
      const persOverlap = pers1.filter(p => pers2.includes(p)).length;
      matches.personalInterests.score = Math.min(persOverlap * 2.5, 5);
      totalScore += matches.personalInterests.score;

      return { score: Math.round(totalScore), matches };
    }

    function convertUser(user) {
      const currentYear = new Date().getFullYear();
      return {
        id: user.id,
        firstName: user.first_name || '',
        lastName: user.last_name || '',
        age: user.year_born ? currentYear - user.year_born : 0,
        gender: user.gender || '',
        industry: user.industry || '',
        networkingGoals: user.networking_goals || '',
        orgsAttend: Array.isArray(user.organizations_current) ? user.organizations_current.join(', ') : (user.organizations_current || ''),
        orgsWantToCheckOut: Array.isArray(user.organizations_interested) ? user.organizations_interested.join(', ') : (user.organizations_interested || ''),
        professionalInterests: Array.isArray(user.professional_interests) ? user.professional_interests.join(', ') : (user.professional_interests || ''),
        personalInterests: Array.isArray(user.personal_interests) ? user.personal_interests.join(', ') : (user.personal_interests || ''),
        genderPreference: user.gender_preference || 'No preference',
        agePreference: user.year_born_connect || 'No Preference'
      };
    }

    async function runReport() {
      try {
        const { data: users, error } = await supabase.from('users').select('*');

        if (error) throw error;

        const chantel = users.find(u => u.email === 'chantel@mittenhomeinfusion.com');
        if (!chantel) {
          document.getElementById('loading').innerHTML = '‚ùå Chantel not found!';
          return;
        }

        const chantelFormatted = convertUser(chantel);
        const results = [];

        for (const user of users) {
          if (user.email === 'chantel@mittenhomeinfusion.com') continue;

          const userFormatted = convertUser(user);
          const compatibility = calculateCompatibility(chantelFormatted, userFormatted);

          results.push({
            name: `${user.first_name} ${user.last_name}`,
            email: user.email,
            company: user.company || 'N/A',
            industry: user.industry || 'N/A',
            score: compatibility.score,
            breakdown: compatibility.matches
          });
        }

        results.sort((a, b) => b.score - a.score);

        // Show stats
        const avgScore = (results.reduce((sum, r) => sum + r.score, 0) / results.length).toFixed(1);
        const above65 = results.filter(r => r.score >= 65).length;
        const between50and64 = results.filter(r => r.score >= 50 && r.score < 65).length;

        document.getElementById('stats').innerHTML = `
          <h2>üìä Statistics</h2>
          <p><strong>Total users evaluated:</strong> ${results.length}</p>
          <p><strong>Average compatibility:</strong> ${avgScore}%</p>
          <p><strong>Users above threshold (65%):</strong> ${above65} ‚úÖ</p>
          <p><strong>Users close (50-64%):</strong> ${between50and64} ‚ö†Ô∏è</p>
          <p><strong>Highest score:</strong> ${results[0].score}%</p>
          <p><strong>Lowest score:</strong> ${results[results.length - 1].score}%</p>
        `;
        document.getElementById('stats').style.display = 'block';

        // Show table
        const tbody = document.getElementById('tbody');
        results.forEach((r, i) => {
          const row = tbody.insertRow();
          let className = 'fail';
          let status = '‚ùå Below threshold';
          if (r.score >= 65) {
            className = 'pass';
            status = '‚úÖ Would match';
          } else if (r.score >= 50) {
            className = 'close';
            status = '‚ö†Ô∏è Close';
          }

          row.className = className;
          row.innerHTML = `
            <td>${i + 1}</td>
            <td>${r.name}</td>
            <td>${r.email}</td>
            <td>${r.company}</td>
            <td>${r.industry}</td>
            <td><strong>${r.score}%</strong></td>
            <td>${status}</td>
            <td>${r.breakdown.networkingGoals.score}/25</td>
            <td>${r.breakdown.organizations.score}/50</td>
            <td>${r.breakdown.professionalInterests.score}/15</td>
            <td>${r.breakdown.industry.score}/5</td>
            <td>${r.breakdown.gender.score}/5</td>
            <td>${r.breakdown.age.score}/5</td>
            <td>${r.breakdown.personalInterests.score}/5</td>
          `;
        });

        document.getElementById('results').style.display = 'table';
        document.getElementById('loading').style.display = 'none';

      } catch (error) {
        document.getElementById('loading').innerHTML = '‚ùå Error: ' + error.message;
      }
    }

    runReport();
  </script>
</body>
</html>
